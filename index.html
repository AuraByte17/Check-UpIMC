<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Calculadora de IMC e An√°lise de Sa√∫de v3</title>
  <style>
    :root {
      --primary-color: #007bff; 
      --primary-darker: #0056b3;
      --secondary-color: #6c757d; 
      --secondary-darker: #5a6268;
      --success-color: #28a745; 
      --success-darker: #1e7e34;
      --info-color: #17a2b8; 
      --info-darker: #117a8b;
      --danger-color: #dc3545; 
      --danger-darker: #c82333;
      --warning-color: #ffc107; 
      --light-bg: #f8f9fa;
      --lighter-bg: #ffffff;
      --text-color: #212529; 
      --text-muted: #6c757d;
      --border-color: #dee2e6;
      --border-radius-sm: 0.25rem; 
      --border-radius-md: 0.5rem;  
      --border-radius-lg: 0.75rem; 
      --shadow-sm: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
      --shadow-md: 0 0.5rem 1rem rgba(0,0,0,0.1);
      --shadow-lg: 0 1rem 3rem rgba(0,0,0,0.12);
      --font-family-sans-serif: 'Segoe UI', Roboto, "Helvetica Neue", Arial, sans-serif;
      --transition-speed: 0.25s;
      --input-focus-color: rgba(0,123,255,.25);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-family-sans-serif);
      background-color: #e9ecef; 
      color: var(--text-color);
      padding: 1rem;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: 1140px; 
      margin: 2rem auto;
      background: var(--lighter-bg);
      padding: clamp(2rem, 4vw, 3.5rem); 
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-lg);
    }

    h1#mainTitle { 
      text-align: center;
      color: var(--primary-darker);
      margin-bottom: 2.5rem;
      font-weight: 600;
      font-size: clamp(2rem, 5vw, 2.6rem); 
    }

    .grid {
      display: grid;
      gap: 3rem; 
      grid-template-columns: 360px 1fr; 
    }
    @media(max-width: 992px) { .grid { grid-template-columns: 1fr; } } 

    .card {
      background: var(--lighter-bg);
      padding: clamp(1.5rem, 3vw, 2.5rem);
      border-radius: var(--border-radius-md);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-md); 
    }
    .profiles.card { background: var(--light-bg); }

    .card h2 {
      color: var(--primary-darker);
      margin-bottom: 1.8rem; 
      font-weight: 500;
      font-size: 1.6rem;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0.85rem;
    }

    .profile-list {
      max-height: 320px; overflow-y: auto; margin-bottom: 1.8rem;
      padding-right: 0.5rem; 
    }
    .profile-list::-webkit-scrollbar { width: 8px; }
    .profile-list::-webkit-scrollbar-thumb { background: #adb5bd; border-radius: var(--border-radius-sm); }
    .profile-list::-webkit-scrollbar-track { background: #e9ecef; }

    .profile-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 1rem 1.25rem; border-radius: var(--border-radius-md);
      cursor: pointer; transition: all var(--transition-speed) ease-out;
      margin-bottom: 0.85rem; border: 1px solid var(--border-color);
      background-color: var(--lighter-bg);
    }
    .profile-item:hover {
      background-color: #e9f3ff;
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 0.25rem 0.75rem rgba(0,0,0,0.07);
    }
    .profile-item.selected {
      background-color: var(--primary-color); color: var(--lighter-bg);
      border-color: var(--primary-darker);
      box-shadow: 0 0.25rem 0.75rem rgba(0,123,255,0.25);
      transform: translateY(0) scale(1);
    }
    .profile-item.selected .info .name, .profile-item.selected .info .gender-emoji { color: var(--lighter-bg); }
    .profile-item.selected button.action-btn { color: #ffe0e3; }
    .profile-item.selected button.action-btn:hover { color: #ffd0d5; background-color: rgba(255,255,255,0.1); }

    .profile-item .info { display: flex; align-items: center; gap: 1rem; }
    .profile-item .info .gender-emoji { font-size: 1.8rem; line-height: 1; }
    .profile-item .info .name { font-weight: 500; font-size: 1.1rem; }
    .profile-item .actions { display: flex; gap: 0.5rem; }
    .profile-item button.action-btn {
      background: transparent; border: none; font-size: 1.15rem; line-height: 1;
      cursor: pointer; padding: 0.45rem 0.65rem; border-radius: var(--border-radius-sm);
      transition: color var(--transition-speed), background-color var(--transition-speed);
    }
    .profile-item button.edit-btn { color: var(--primary-color); }
    .profile-item button.edit-btn:hover { color: var(--primary-darker); background-color: rgba(0,123,255,0.08); }
    .profile-item button.delete-btn { color: var(--danger-color); }
    .profile-item button.delete-btn:hover { color: var(--danger-darker); background-color: rgba(220,53,69,0.08); }

    .profiles form { display: grid; gap: 1.1rem; }
    .profiles input, .profiles select {
      width: 100%; padding: 1rem 1.1rem; border: 1px solid var(--border-color);
      border-radius: var(--border-radius-md); font-size: 1rem; background-color: var(--lighter-bg);
      transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
    }
    .profiles input:focus, .profiles select:focus {
      border-color: var(--primary-color); box-shadow: 0 0 0 0.2rem var(--input-focus-color); outline: none;
    }
    .profiles button#profileSubmitBtn {
      margin-top: 0.5rem; 
    }
    .age-inputs { display: flex; gap: 0.85rem; } .age-inputs input { width: 100%; }

    #selectedProfileInfo {
      font-size: 1.15rem; background-color: #e6f2ff; 
      padding: 1rem 1.3rem; border-radius: var(--border-radius-md);
      border-left: 5px solid var(--primary-color);
      margin-bottom: 1rem; 
    }
     #calculateBtn { 
        margin-top: 0.5rem; 
    }


    .btn { 
        width: fit-content; padding: .9rem 1.6rem; color: #fff; border: none;
        border-radius: var(--border-radius-md); cursor: pointer; font-size: 1rem; font-weight: 500;
        text-align: center; vertical-align: middle;
        transition: background-color var(--transition-speed), transform var(--transition-speed), box-shadow var(--transition-speed);
    }
    .btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: var(--shadow-sm); }
    .btn:disabled { cursor: not-allowed; opacity: 0.65; transform: none; box-shadow: none; }

    .btn-primary { background-color: var(--primary-color); } .btn-primary:hover:not(:disabled) { background-color: var(--primary-darker); }
    .btn-success { background-color: var(--success-color); } .btn-success:hover:not(:disabled) { background-color: var(--success-darker); }
    .btn-info { background-color: var(--info-color); } .btn-info:hover:not(:disabled) { background-color: var(--info-darker); }
    .btn-secondary { background-color: var(--secondary-color); } .btn-secondary:hover:not(:disabled) { background-color: var(--secondary-darker); }


    .result-section {
      background: var(--light-bg); padding: 1.8rem; border-radius: var(--border-radius-md);
      margin-top: 1rem; border: 1px solid var(--border-color);
      opacity: 0; transform: translateY(20px); max-height: 0; overflow: hidden;
      transition: opacity 0.4s ease-out, transform 0.4s ease-out, max-height 0.5s ease-out;
    }
    .result-section.visible { opacity: 1; transform: translateY(0); max-height: 3000px; overflow: visible; }
    .result-section h3 {
      color: var(--primary-darker); margin-bottom: 1.2rem; font-weight: 500;
      font-size: 1.3rem; border-bottom: 1px solid #d0d9e3; padding-bottom: 0.6rem;
    }
    .result-section p em { font-size: .9em; color: var(--text-muted); }
    .result-section p.activity-feedback em { font-weight: 500; color: var(--info-darker); }

    .chart-toggle-buttons { display: flex; gap: 0.75rem; margin-bottom: 1rem; }
    .chart-toggle-buttons button { flex-grow: 1; font-size: 0.9rem; } 
    .chart-toggle-buttons button.active-chart-btn { background-color: var(--primary-color); font-weight: 600; }
    .chart-toggle-buttons button:not(.active-chart-btn) { background-color: var(--secondary-color); }
    .chart-toggle-buttons button:not(.active-chart-btn):hover { background-color: var(--secondary-darker); }
    
    .charts-container { margin-top: 0.5rem; }
    .charts-container canvas {
      width: 100% !important; border-radius: var(--border-radius-md); background: var(--lighter-bg);
      border: 1px solid var(--border-color); padding: 1rem; box-shadow: var(--shadow-sm);
    }
    #growthChartCanvas { height: 350px !important; }
    #currentStatusChartCanvas { height: 320px !important; display: none; }

    .export-container { margin-top: 1.5rem; text-align: right; }

    #actionPlan ul { list-style-type: none; padding-left: 0; }
    .action-plan-item {
        display: flex; align-items: flex-start; margin-bottom: 1rem;
        padding: 0.8rem 1rem; border-radius: var(--border-radius-sm);
        background-color: var(--lighter-bg); border: 1px solid var(--border-color);
        box-shadow: var(--shadow-sm);
    }
    .action-plan-item::before { 
        margin-right: 0.75rem; font-size: 1.2em; line-height: 1.4; 
    }
    .action-plan-general::before { content: "‚ÑπÔ∏è"; }
    .action-plan-medical::before { content: "‚öïÔ∏è"; color: var(--danger-color); }
    .action-plan-diet::before { content: "ü•ó"; color: var(--success-color); }
    .action-plan-activity::before { content: "üèÉ"; color: var(--warning-color); }
    .action-plan-lifestyle::before { content: "üåô"; color: var(--info-color); }


    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.55); backdrop-filter: blur(3px); }
    .modal-content { background-color: #fff; margin: 5% auto; padding: 30px; border: none; width: 90%; max-width: 750px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); animation: modalAppear 0.3s ease-out; max-height: 80vh; overflow-y: auto; }
    @keyframes modalAppear { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    .modal-close { color: #888; float: right; font-size: 32px; font-weight: bold; cursor: pointer; line-height: 1; }
    .modal-close:hover, .modal-close:focus { color: #333; text-decoration: none; }
    .modal h2 { color: #005ea2; margin-bottom: 1.5rem; font-size: 1.8rem; }
    .modal h3 { color: #00528e; margin-top: 1.8rem; margin-bottom: 0.75rem; font-size: 1.3rem; }
    .modal p, .modal ul { margin-bottom: 1.2rem; line-height: 1.7; font-size: 1rem; }
    .modal ul { list-style-position: outside; padding-left: 1.5em; } .modal li { margin-bottom: 0.6rem; }

  </style>
</head>
<body>
  <div class="container">
    <h1 id="mainTitle">Calculadora de IMC e An√°lise de Sa√∫de</h1>
    <div class="grid">
      <div class="profiles card">
        <h2>Perfis</h2>
        <div id="profilesContainer" class="profile-list"></div>
        <form id="profileForm">
          <input id="nickname" placeholder="Nome do Perfil" required/>
          <div class="age-inputs">
            <input id="ageYears" type="number" min="1" max="120" placeholder="Idade (Anos)" required/>
            <input id="ageMonths" type="number" min="0" max="11" placeholder="Meses (0-11)" required title="Para crian√ßas/adolescentes, ou deixe 0 para adultos"/>
          </div>
          <select id="genero" required>
            <option value="" disabled selected>G√©nero Biol√≥gico</option>
            <option value="Masculino">Masculino</option>
            <option value="Feminino">Feminino</option>
          </select>
          <input id="height" type="number" min="30" max="250" placeholder="Altura (cm)" required/>
          <input id="weight" type="number" min="2" max="300" step="0.1" placeholder="Peso (kg)" required/>
          <select id="activity" required>
            <option value="" disabled selected>N√≠vel de Atividade F√≠sica</option>
            <option value="Sedent√°rio">Sedent√°rio (pouco/nenhum exerc√≠cio)</option>
            <option value="Moderado">Moderado (exerc√≠cio leve 1-3x/semana)</option>
            <option value="Ativo">Ativo (exerc√≠cio moderado/intenso 3-5x/semana)</option>
            <option value="Muito Ativo">Muito Ativo (exerc√≠cio intenso 6-7x/semana)</option>
          </select>
          <button type="submit" id="profileSubmitBtn" class="btn btn-primary">Criar Perfil</button>
        </form>
      </div>

      <div class="calculator card">
        <h2>Calculadora & An√°lise</h2>
        <p id="selectedProfileInfo"><strong>Perfil Selecionado:</strong> <span id="selectedProfileName">Nenhum</span></p>
        <button id="calculateBtn" class="btn btn-success" disabled>Calcular & Analisar</button>

        <div id="result" class="result-section">
          <h3>Resultados da Avalia√ß√£o</h3>
          <p>Altura (usada): <strong id="profileHeight"></strong> cm</p>
          <p>Peso (usado): <strong id="profileWeight"></strong> kg</p>
          <p>IMC: <strong id="imcValue"></strong> kg/m¬≤</p>
          <p id="zScoreRow">Z-Score (OMS): <strong id="whoZScore"></strong></p>
          <p id="percentileRow">Percentil (OMS): <strong id="whoPercentile"></strong>¬∫</p>
          <p>Categoria de IMC: <strong id="whoCategory"></strong></p>
          <p class="activity-feedback">N√≠vel de Atividade: <strong id="profileActivityLevel"></strong> - <em id="activityRelevanceComment"></em></p>
          <p><em><span id="ageDisclaimer">Valores Z-Score e Percentil s√£o para crian√ßas/adolescentes (OMS simplificado).</span> Consulte um profissional de sa√∫de.</em></p>
        </div>

        <div class="result-section" id="chartSection">
            <h3>Gr√°ficos de Avalia√ß√£o</h3>
            <div class="chart-toggle-buttons">
                <button id="showGrowthChartBtn" class="btn active-chart-btn">Evolu√ß√£o do IMC</button>
                <button id="showStatusChartBtn" class="btn">Status Atual do IMC</button>
            </div>
            <div class="charts-container">
                <canvas id="growthChartCanvas"></canvas>
                <canvas id="currentStatusChartCanvas" style="display:none;"></canvas>
            </div>
        </div>
        <div id="actionPlan" class="result-section">
          <h3>Plano de A√ß√£o Sugerido</h3>
          <ul id="planList"></ul>
          <p style="font-size:.9em;color:#555;margin-top:0.5rem;"><em>Lembre-se: estas s√£o sugest√µes gerais e baseadas em dados simplificados. Consulte sempre um profissional de sa√∫de para aconselhamento personalizado.</em></p>
        </div>
        
        <button id="learnMoreBtn" class="btn btn-info">Aprender Mais sobre IMC e Sa√∫de</button>
        <div class="export-container">
            <button id="exportBtn" class="btn btn-secondary" disabled>Exportar Relat√≥rio (PDF)</button>
        </div>
      </div>
    </div>
  </div>

  <div id="educationalModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" id="modalCloseBtn">&times;</span>
      <h2>Aprender Mais sobre IMC e Sa√∫de</h2>
      <section id="edu-bmi"> 
        <h3>Compreender o IMC</h3> 
        <p>O √çndice de Massa Corporal (IMC) √© uma ferramenta que usa a sua altura e peso para ajudar a perceber se o seu peso est√° dentro de uma faixa considerada saud√°vel. √â um ponto de partida √∫til, mas n√£o conta toda a hist√≥ria sobre a sua sa√∫de, pois n√£o distingue entre m√∫sculo e gordura.</p>
        
        <h4>Para Crian√ßas e Adolescentes (at√© 19 anos)</h4>
        <p>Nas crian√ßas e adolescentes, o IMC n√£o √© visto como um n√∫mero isolado. Em vez disso, compara-se o IMC da crian√ßa com o de outras da mesma idade e sexo biol√≥gico usando <strong>Z-Scores</strong> (ou desvios padr√£o) e <strong>percentis</strong>. Isto acontece porque o corpo das crian√ßas est√° sempre a mudar e a crescer.</p>
        <ul>
            <li><strong>Z-Score:</strong> Indica qu√£o longe o IMC da crian√ßa est√° da m√©dia (Z-Score 0) para a sua idade e sexo.
                <ul>
                    <li>Um Z-Score perto de 0 (correspondendo ao percentil 50¬∫) √© geralmente considerado dentro da m√©dia.</li>
                    <li>Valores positivos altos (ex: > +1 ou > +2) podem indicar risco de excesso de peso ou obesidade.</li>
                    <li>Valores negativos baixos (ex: < -2) podem indicar risco de baixo peso.</li>
                </ul>
            </li>
            <li><strong>Percentil:</strong> Mostra a posi√ß√£o do IMC da crian√ßa em rela√ß√£o a 100 crian√ßas da mesma idade e sexo. Se uma crian√ßa est√° no percentil 60, significa que 60% das crian√ßas t√™m um IMC inferior ao dela.</li>
            <li>As curvas de crescimento da OMS (Organiza√ß√£o Mundial da Sa√∫de) que v√™ no gr√°fico de evolu√ß√£o ajudam a visualizar esta compara√ß√£o. Para adultos, estas curvas de refer√™ncia n√£o s√£o usadas; em vez disso, usam-se as categorias de IMC fixas.</li>
        </ul>
        
        <h4>Para Adultos (20 anos ou mais)</h4>
        <p>Nos adultos, o IMC √© interpretado usando categorias fixas, pois o crescimento em altura j√° terminou. Estas categorias d√£o uma ideia geral do risco para a sa√∫de associado ao peso:</p>
        <ul>
            <li><strong>Baixo Peso:</strong> IMC < 18.5</li>
            <li><strong>Peso Normal:</strong> IMC 18.5 ‚Äì 24.9</li>
            <li><strong>Excesso de Peso (Sobrepeso):</strong> IMC 25 ‚Äì 29.9</li>
            <li><strong>Obesidade Grau I:</strong> IMC 30 ‚Äì 34.9</li>
            <li><strong>Obesidade Grau II:</strong> IMC 35 ‚Äì 39.9</li>
            <li><strong>Obesidade Grau III (M√≥rbida):</strong> IMC ‚â• 40</li>
        </ul>
        <p><strong>Importante:</strong> O IMC √© apenas um indicador. Fatores como a massa muscular, a estrutura √≥ssea e a distribui√ß√£o de gordura n√£o s√£o tidos em conta. Por exemplo, um atleta pode ter um IMC alto devido √† massa muscular e n√£o por excesso de gordura. Por isso, para uma avalia√ß√£o completa da sua sa√∫de e do seu peso, √© fundamental consultar um m√©dico ou nutricionista.</p> 
      </section>
      <section id="edu-nutrition"><h3>Dicas para uma Alimenta√ß√£o Saud√°vel (Todas as Idades)</h3><p>Uma alimenta√ß√£o equilibrada √© fundamental para a sa√∫de e bem-estar em todas as fases da vida.</p><ul><li><strong>Priorize Alimentos Naturais:</strong> Baseie a sua alimenta√ß√£o em frutas, vegetais, leguminosas, cereais integrais, prote√≠nas magras (peixe, aves, ovos, tofu) e gorduras saud√°veis (azeite, abacate, frutos secos).</li><li><strong>Modere os Processados:</strong> Reduza o consumo de alimentos ultraprocessados, ricos em a√ß√∫cares adicionados, sal e gorduras n√£o saud√°veis.</li><li><strong>Hidrate-se:</strong> Beba √°gua regularmente ao longo do dia.</li><li><strong>Controle as Por√ß√µes:</strong> Esteja atento ao tamanho das por√ß√µes para evitar excessos.</li><li><strong>Cozinhe Mais em Casa:</strong> Preparar as suas refei√ß√µes d√°-lhe controlo sobre os ingredientes e a forma de cozinhar.</li></ul><p><em>Para orienta√ß√µes espec√≠ficas, especialmente se tiver condi√ß√µes de sa√∫de, consulte um nutricionista.</em></p></section>
      <section id="edu-activity"><h3>A Import√¢ncia da Atividade F√≠sica (Todas as Idades)</h3><p>Ser fisicamente ativo traz in√∫meros benef√≠cios para a sa√∫de f√≠sica e mental.</p><p><strong>Recomenda√ß√µes Gerais (OMS):</strong></p><ul><li><strong>Crian√ßas e Adolescentes (5-17 anos):</strong> Pelo menos 60 minutos por dia de atividade f√≠sica de intensidade moderada a vigorosa.</li><li><strong>Adultos (18-64 anos):</strong> Pelo menos 150-300 minutos de atividade f√≠sica aer√≥bica de intensidade moderada, ou 75-150 minutos de atividade vigorosa por semana, mais atividades de fortalecimento muscular 2x/semana.</li><li><strong>Idosos (65+ anos):</strong> Semelhante aos adultos, com √™nfase em atividades que melhorem o equil√≠brio e previnam quedas.</li></ul><p>Encontre atividades que lhe d√™em prazer para que seja mais f√°cil manter a regularidade!</p></section>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    console.log("DOM fully loaded. Initializing app (healthAnalyzerApp_v2_refined)...");

    const $ = (id, context = document) => {
        const el = context.getElementById(id);
        if (!el && id) console.warn(`Element with ID '${id}' not found in context:`, context.nodeName);
        return el;
    };
    const setText = (id, text) => { const el = $(id); if (el) el.textContent = String(text === null || text === undefined ? '' : text); else console.warn(`setText: Element '${id}' not found for text: "${text}"`); };
    const setHTML = (id, html) => { const el = $(id); if (el) el.innerHTML = html; else console.warn(`setHTML: Element '${id}' not found for HTML.`); };

    const ui = {
        growthChartCanvasEl: $('growthChartCanvas'),
        currentStatusChartCanvasEl: $('currentStatusChartCanvas'),
        exportBtn: $('exportBtn'),
        profileForm: $('profileForm'),
        profileSubmitBtn: $('profileSubmitBtn'),
        learnMoreBtn: $('learnMoreBtn'),
        educationalModal: $('educationalModal'),
        modalCloseBtn: $('modalCloseBtn'),
        calculateBtn: $('calculateBtn'),
        showGrowthChartBtn: $('showGrowthChartBtn'),
        showStatusChartBtn: $('showStatusChartBtn'),
        profilesContainer: $('profilesContainer'),
        selectedProfileName: $('selectedProfileName'),
        nicknameInput: $('nickname'), ageYearsInput: $('ageYears'), ageMonthsInput: $('ageMonths'),
        generoSelect: $('genero'), heightInput: $('height'), weightInput: $('weight'), activitySelect: $('activity'),
        profileHeight: $('profileHeight'), profileWeight: $('profileWeight'),
        imcValue: $('imcValue'), whoZScore: $('whoZScore'), whoPercentile: $('whoPercentile'),
        whoCategory: $('whoCategory'), profileActivityLevel: $('profileActivityLevel'),
        activityRelevanceComment: $('activityRelevanceComment'),
        resultSection: $('result'),
        chartSection: $('chartSection'),
        actionPlanSection: $('actionPlan'), planList: $('planList'),
        mainTitle: $('mainTitle'),
        ageDisclaimer: $('ageDisclaimer'), 
        zScoreRow: $('zScoreRow'), 
        percentileRow: $('percentileRow'),
    };

    const growthChartCtx = ui.growthChartCanvasEl ? ui.growthChartCanvasEl.getContext('2d') : null;
    const currentStatusChartCtx = ui.currentStatusChartCanvasEl ? ui.currentStatusChartCanvasEl.getContext('2d') : null;
    
    if (!growthChartCtx) console.error("Growth chart canvas context (growthChartCtx) is null!");
    if (!currentStatusChartCtx) console.error("Current status chart canvas context (currentStatusChartCtx) is null!");


    let profiles = JSON.parse(localStorage.getItem('healthAnalyzerApp_v2_refined') || '[]');
    let selectedProfileIndex = -1;
    let isEditingProfile = false;
    let growthChartInstance;
    let currentStatusChartInstance;
    
    if (typeof Chart !== 'undefined') { Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"; }
    else { console.error("Chart.js library not loaded!"); if(ui.showGrowthChartBtn) ui.showGrowthChartBtn.disabled = true; if(ui.showStatusChartBtn) ui.showStatusChartBtn.disabled = true; }

    const whoLMS_BMI = { rapaz: {60:[-1.363,15.304,0.0772],72:[-1.427,15.579,0.0797],84:[-1.487,15.969,0.0835],96:[-1.523,16.452,0.0883],108:[-1.517,17.004,0.0939],120:[-1.458,17.614,0.1001],132:[-1.342,18.282,0.1069],144:[-1.172,19.012,0.1141],156:[-0.958,19.808,0.1216],168:[-0.718,20.664,0.1291],180:[-0.474,21.560,0.1363],192:[-0.245,22.471,0.1429],204:[-0.052,23.362,0.1485],216:[0.106,24.196,0.1529],228:[0.238,24.948,0.1561]},rapariga:{60:[-1.592,15.048,0.0792],72:[-1.684,15.297,0.0832],84:[-1.769,15.696,0.0888],96:[-1.820,16.234,0.0958],108:[-1.799,16.900,0.1039],120:[-1.698,17.682,0.1128],132:[-1.521,18.565,0.1221],144:[-1.287,19.517,0.1313],156:[-1.021,20.493,0.1399],168:[-0.750,21.444,0.1473],180:[-0.501,22.328,0.1532],192:[-0.292,23.114,0.1574],204:[-0.136,23.781,0.1601],216:[-0.031,24.327,0.1615],228:[0.031,24.755,0.1618]}};
    
    function getLMSForAge(sexInput, totalMonths) {
        const sexKey = sexInput === "Masculino" ? "rapaz" : (sexInput === "Feminino" ? "rapariga" : null);
        if (!sexKey) { console.error("Invalid sex input for LMS lookup:", sexInput); return null; }
        const sexData = whoLMS_BMI[sexKey];
        if (!sexData) return null;
        const availableMonths = Object.keys(sexData).map(Number).sort((a, b) => a - b);
        let closestMonth = availableMonths[0];
        for (const month of availableMonths) { if (month <= totalMonths) { closestMonth = month; } else { break; } }
        if (totalMonths > 228 && (closestMonth < 228)) closestMonth = 228; 
        if (totalMonths < 60 && (closestMonth > 60 || availableMonths.includes(60))) closestMonth = 60; 
        return sexData[closestMonth] || null;
    }
    function calculateZScore(bmi, totalMonths, sex) { const lms=getLMSForAge(sex,totalMonths);if(!lms)return null;const[L,M,S]=lms;let z;if(L!==0){z=(Math.pow(bmi/M,L)-1)/(L*S);}else{z=Math.log(bmi/M)/S;} return z;}
    function zScoreToPercentile(z) { if(z===null||isNaN(z))return null;const p=0.2316419,b1=0.31938153,b2=-0.356563782,b3=1.781477937,b4=-1.821255978,b5=1.330274429;const t=1/(1+p*Math.abs(z));const pdf=(1/Math.sqrt(2*Math.PI))*Math.exp(-0.5*z*z);let cdf=1-pdf*(b1*t+b2*Math.pow(t,2)+b3*Math.pow(t,3)+b4*Math.pow(t,4)+b5*Math.pow(t,5));if(z<0)cdf=1-cdf;return cdf*100;}
    
    function getBMICategory(bmi, ageYears) { // For Adults
        if (ageYears >= 20) { 
            if (bmi < 18.5) return "Baixo Peso";
            if (bmi < 25) return "Peso Normal";
            if (bmi < 30) return "Excesso de Peso (Sobrepeso)";
            if (bmi < 35) return "Obesidade Grau I";
            if (bmi < 40) return "Obesidade Grau II";
            return "Obesidade Grau III (M√≥rbida)";
        } else if (ageYears >= 1) { 
            return "Avalia√ß√£o por Z-Score (OMS)"; 
        }
        return "N/A (idade inv√°lida)";
    }

    function getWHOCategoryForChild(zScore, totalMonths) { 
        if(zScore===null||isNaN(zScore))return"N/A";
        const ageYears = totalMonths / 12;
        if(ageYears >= 1 && ageYears < 20){ 
            if(zScore > 2)return"Risco de Obesidade";
            if(zScore > 1)return"Risco de Excesso de Peso";
            if(zScore < -2){return zScore < -3 ? "Risco de Magreza Acentuada" : "Risco de Baixo Peso (Magreza)";}
            return"Peso Normal";
        }
        return "N/A (Z-Score n√£o aplic√°vel a esta idade)";
    }
    
    function calculateBMIFromZScore(zValue, totalMonths, sex) { const lms=getLMSForAge(sex,totalMonths);if(!lms)return null;const[L,M,S]=lms;if(L!==0){return M*Math.pow((L*S*zValue+1),(1/L));}else{return M*Math.exp(S*zValue);}}
    
    function saveProfiles() { localStorage.setItem('healthAnalyzerApp_v2_refined', JSON.stringify(profiles)); }

    function populateFormForEdit(profile) {
        if(ui.nicknameInput) ui.nicknameInput.value = profile.nickname; 
        if(ui.ageYearsInput) ui.ageYearsInput.value = profile.ageYears; 
        if(ui.ageMonthsInput) ui.ageMonthsInput.value = profile.ageMonthsSub;
        if(ui.generoSelect) ui.generoSelect.value = profile.genero; 
        if(ui.heightInput) ui.heightInput.value = profile.height; 
        if(ui.weightInput) ui.weightInput.value = profile.weight;
        if(ui.activitySelect) ui.activitySelect.value = profile.activity; 
        if(ui.profileSubmitBtn) ui.profileSubmitBtn.textContent = "Guardar Altera√ß√µes";
        setText('mainTitle', "Editar Perfil"); isEditingProfile = true;
    }
    function resetProfileForm() { 
        if (ui.profileForm) ui.profileForm.reset();
        if (ui.profileSubmitBtn) ui.profileSubmitBtn.textContent = "Criar Perfil";
        setText('mainTitle', "Calculadora de IMC e An√°lise de Sa√∫de");
        isEditingProfile = false;
    }
    function renderProfilesList() {
        if (!ui.profilesContainer) { console.error("profilesContainer not found in renderProfilesList"); return; }
        ui.profilesContainer.innerHTML=''; if(profiles.length===0){setHTML('profilesContainer','<p style="text-align:center;color:#777;">Nenhum perfil.</p>');return;}
        profiles.forEach((profile,index)=>{const item=document.createElement('div');item.className='profile-item';if(index===selectedProfileIndex&&!isEditingProfile){item.classList.add('selected');}item.onclick=()=>{if(isEditingProfile){if(selectedProfileIndex!==index&&!confirm("Descartar altera√ß√µes n√£o guardadas?"))return;resetProfileForm();renderProfilesList();updateSelectedProfileDisplay();selectedProfileIndex=-1;}selectedProfileIndex=index;renderProfilesList();updateSelectedProfileDisplay();clearResultsAndCharts();/*Goal display call removed*/};const infoDiv=document.createElement('div');infoDiv.className='info';const genderEmojiSpan=document.createElement('span');genderEmojiSpan.className='gender-emoji';genderEmojiSpan.textContent=profile.genero==='Masculino'?'üë¶':'üëß';const nameSpan=document.createElement('span');nameSpan.className='name';nameSpan.textContent=profile.nickname;infoDiv.append(genderEmojiSpan,nameSpan);const actionsDiv=document.createElement('div');actionsDiv.className='actions';const editBtn=document.createElement('button');editBtn.innerHTML='‚úèÔ∏è';editBtn.className='action-btn edit-btn';editBtn.title='Editar';editBtn.onclick=(e)=>{e.stopPropagation();clearResultsAndCharts();selectedProfileIndex=index;populateFormForEdit(profiles[index]);renderProfilesList();updateSelectedProfileDisplay();};const deleteBtn=document.createElement('button');deleteBtn.innerHTML='&times;';deleteBtn.className='action-btn delete-btn';deleteBtn.title='Remover';deleteBtn.onclick=e=>{e.stopPropagation();if(confirm(`Remover ${profile.nickname}?`)){if(isEditingProfile&&selectedProfileIndex===index){resetProfileForm();}profiles.splice(index,1);if(selectedProfileIndex===index){selectedProfileIndex=-1;clearResultsAndCharts();}else if(selectedProfileIndex>index){selectedProfileIndex--;}saveProfiles();renderProfilesList();updateSelectedProfileDisplay();}};actionsDiv.append(editBtn,deleteBtn);item.append(infoDiv,actionsDiv);ui.profilesContainer.appendChild(item);});
    }
    function updateSelectedProfileDisplay() {
        const profileSelectedForAnalysis=selectedProfileIndex>=0&&!isEditingProfile;
        if(isEditingProfile&&selectedProfileIndex>=0&&profiles[selectedProfileIndex]){setHTML('selectedProfileName',`<span style="color:#0056b3;font-style:italic;">${profiles[selectedProfileIndex].nickname} (a editar...)</span>`);}
        else if(profileSelectedForAnalysis&&profiles[selectedProfileIndex]){setText('selectedProfileName',profiles[selectedProfileIndex].nickname);}
        else{setText('selectedProfileName','Nenhum');}
        if(ui.calculateBtn) ui.calculateBtn.disabled=!profileSelectedForAnalysis;
        // Goal section display logic REMOVED
        if(!profileSelectedForAnalysis){if(ui.exportBtn)ui.exportBtn.disabled=true;if(!isEditingProfile){clearResultsAndCharts();}}
    }
    function clearResultsAndCharts() {
        ['result','actionPlan','chartSection'/*,'goalTrackingSection' REMOVED*/].forEach(id=>{const el=$(id);if(el)el.classList.remove('visible');});
        if(growthChartInstance){growthChartInstance.destroy();growthChartInstance=null;}
        if(currentStatusChartInstance){currentStatusChartInstance.destroy();currentStatusChartInstance=null;}
        if(ui.exportBtn) ui.exportBtn.disabled = true;
        // Goal display reset REMOVED
        if(ui.growthChartCanvasEl) ui.growthChartCanvasEl.style.display='block'; if(ui.currentStatusChartCanvasEl) ui.currentStatusChartCanvasEl.style.display='none';
        if(ui.showGrowthChartBtn) ui.showGrowthChartBtn.classList.add('active-chart-btn'); if(ui.showStatusChartBtn) ui.showStatusChartBtn.classList.remove('active-chart-btn');
    }

    if (ui.profileForm) {
        ui.profileForm.onsubmit = e => {
            e.preventDefault();
            console.log("profileForm submitted. isEditingProfile:", isEditingProfile, "selectedProfileIndex:", selectedProfileIndex);
            try {
                const ageYears = parseInt(ui.ageYearsInput.value);
                const ageMonthsSub = parseInt(ui.ageMonthsInput.value);
                if (isNaN(ageYears) || isNaN(ageMonthsSub) || ui.ageYearsInput.value === '' || ui.ageMonthsInput.value === '') {
                    alert("Por favor, insira valores v√°lidos para idade (anos e meses)."); return;
                }
                const totalMonths = (ageYears * 12) + ageMonthsSub;

                const profileData = {
                    nickname: ui.nicknameInput.value.trim(),
                    ageYears: ageYears, ageMonthsSub: ageMonthsSub, totalMonthsAtCreation: totalMonths,
                    genero: ui.generoSelect.value, height: parseFloat(ui.heightInput.value),
                    weight: parseFloat(ui.weightInput.value), activity: ui.activitySelect.value,
                    // goals property removed
                };

                if (!profileData.nickname || !profileData.genero || isNaN(profileData.height) || isNaN(profileData.weight) || !profileData.activity) {
                    alert("Por favor, preencha todos os campos obrigat√≥rios corretamente."); return;
                }
                
                if (isEditingProfile && selectedProfileIndex >= 0 && profiles[selectedProfileIndex]) {
                    console.log("Updating profile:", profiles[selectedProfileIndex].nickname);
                    profileData.imcHistory = profiles[selectedProfileIndex].imcHistory || [];
                    // profileData.goals removed
                    profiles[selectedProfileIndex] = profileData;
                    
                    saveProfiles(); alert("Perfil atualizado com sucesso!");
                    const justEditedIndex = selectedProfileIndex;
                    resetProfileForm(); 
                    selectedProfileIndex = justEditedIndex; 
                    renderProfilesList(); updateSelectedProfileDisplay(); displayProfileResults(); 
                } else {
                    console.log("Creating new profile:", profileData.nickname);
                    profileData.imcHistory = [];
                    // profileData.goals removed
                    profiles.push(profileData);
                    selectedProfileIndex = profiles.length - 1;
                    
                    saveProfiles(); 
                    console.log("New profile saved, attempting to display results for index:", selectedProfileIndex);
                    displayProfileResults(); 

                    resetProfileForm(); 
                    renderProfilesList(); updateSelectedProfileDisplay();
                }
            } catch (err) { console.error("Erro ao criar/atualizar perfil:", err); alert("Ocorreu um erro ao processar o perfil: " + err.message); }
        };
    } else { console.error("Profile form (ui.profileForm) not found! Cannot attach onsubmit listener."); }
    
    // displayGoalProgress function REMOVED
    // logStepsBtn onclick REMOVED
    
    const calculateIMC = (weight, height) => weight / ((height / 100) ** 2);

    function displayProfileResults() {
      console.log("Attempting to display results for profile index:", selectedProfileIndex);
      try {
        if (selectedProfileIndex < 0 || isEditingProfile) { console.log("displayProfileResults: No profile or editing. Clearing."); clearResultsAndCharts(); return; }
        const profile = profiles[selectedProfileIndex];
        if (!profile) { console.error("displayProfileResults: Profile object is null/undefined for index", selectedProfileIndex); clearResultsAndCharts(); return; }
        console.log("Displaying results for:", profile.nickname);

        setText('profileHeight', profile.height); setText('profileWeight', profile.weight);
        const imc = parseFloat(calculateIMC(profile.weight, profile.height).toFixed(2));
        const ageYears = profile.ageYears;
        let currentTotalMonths = (ageYears * 12) + profile.ageMonthsSub;
        
        let zScore = null, percentile = null, category = "";

        if (ageYears < 20 && ageYears >= 1) { 
            zScore = calculateZScore(imc, currentTotalMonths, profile.genero);
            percentile = zScoreToPercentile(zScore);
            category = getWHOCategoryForChild(zScore, currentTotalMonths);
            if(ui.zScoreRow) ui.zScoreRow.style.display = 'block';
            if(ui.percentileRow) ui.percentileRow.style.display = 'block';
            if(ui.ageDisclaimer) ui.ageDisclaimer.textContent = "Valores Z-Score e Percentil s√£o para crian√ßas/adolescentes (OMS simplificado).";
        } else if (ageYears >= 20) { 
            category = getBMICategory(imc, ageYears);
            if(ui.zScoreRow) ui.zScoreRow.style.display = 'none';
            if(ui.percentileRow) ui.percentileRow.style.display = 'none';
            if(ui.ageDisclaimer) ui.ageDisclaimer.textContent = "Categorias de IMC para adultos.";
        } else { 
            category = "N/A (c√°lculo para idade >= 1 ano)";
            if(ui.zScoreRow) ui.zScoreRow.style.display = 'none';
            if(ui.percentileRow) ui.percentileRow.style.display = 'none';
            if(ui.ageDisclaimer) ui.ageDisclaimer.textContent = "C√°lculo de IMC para idade >= 1 ano.";
        }

        setText('profileActivityLevel', profile.activity);
        let activityComment = "";
        switch(profile.activity) { case "Sedent√°rio": activityComment = "Importante aumentar para melhor sa√∫de."; break; case "Moderado": activityComment = "Bom! Considerar aumentar se poss√≠vel."; break; case "Ativo": activityComment = "Excelente! Manter este n√≠vel √© √≥timo."; break; case "Muito Ativo": activityComment = "Fant√°stico! Continue assim!"; break; default: activityComment = "N√≠vel de atividade n√£o especificado."; }
        setText('activityRelevanceComment', activityComment);
        
        const today = new Date(); const historyEntry = { date: today, totalMonths: currentTotalMonths, bmi: imc, zScore: zScore, height: profile.height, weight: profile.weight };
        if (!profile.imcHistory) profile.imcHistory = [];
        const existingEntryIndex = profile.imcHistory.findIndex(entry => new Date(entry.date).toLocaleDateString('pt-PT') === today.toLocaleDateString('pt-PT'));
        if (existingEntryIndex > -1) { profile.imcHistory[existingEntryIndex] = historyEntry; } else { profile.imcHistory.push(historyEntry); }
        profile.imcHistory.sort((a,b) => new Date(a.date) - new Date(b.date)); 
        
        setText('imcValue', imc); 
        setText('whoZScore', (ageYears < 20 && zScore !== null) ? zScore.toFixed(2) : "N/A (Adulto)");
        setText('whoPercentile', (ageYears < 20 && percentile !== null) ? percentile.toFixed(1) : "N/A (Adulto)"); 
        setText('whoCategory', category); 
        if (ui.resultSection) ui.resultSection.classList.add('visible');
        
        renderSimplifiedGrowthChart(profile, ageYears); 
        renderCurrentStatusChart(profile, imc, currentTotalMonths, ageYears);
        
        if (ui.chartSection) ui.chartSection.classList.add('visible'); 
        if(ui.growthChartCanvasEl) ui.growthChartCanvasEl.style.display = 'block'; if(ui.currentStatusChartCanvasEl) ui.currentStatusChartCanvasEl.style.display = 'none';
        if(ui.showGrowthChartBtn) ui.showGrowthChartBtn.classList.add('active-chart-btn'); if(ui.showStatusChartBtn) ui.showStatusChartBtn.classList.remove('active-chart-btn');
        
        if (ui.planList) { 
            ui.planList.innerHTML = ''; 
            const planItems = getEnhancedActionPlan(category, ageYears, profile.activity, profile.genero); 
            planItems.forEach(item => { 
                const li = document.createElement('li');
                li.className = `action-plan-item action-plan-${item.type || 'general'}`;
                li.textContent = item.text; 
                li.setAttribute('data-icon', item.type === 'medical' ? '‚öïÔ∏è' : item.type === 'diet' ? 'ü•ó' : item.type === 'activity' ? 'üèÉ' : item.type === 'lifestyle' ? 'üåô' : '‚ÑπÔ∏è'); // For PDF
                ui.planList.appendChild(li); 
            });
        }
        if (ui.actionPlanSection) ui.actionPlanSection.classList.add('visible'); 
        // displayGoalProgress REMOVED
        if(ui.exportBtn) ui.exportBtn.disabled = false;
        console.log("Results displayed successfully for:", profile.nickname);
      } catch (error) { console.error("Erro fatal em displayProfileResults:", error); alert("Ocorreu um erro cr√≠tico ao calcular ou exibir os resultados: " + error.message + ". Verifique a consola."); }
    }
    
    if(ui.calculateBtn) ui.calculateBtn.onclick = () => {
        if (selectedProfileIndex >= 0 && !isEditingProfile && profiles[selectedProfileIndex]) {
            try {
                console.log("Calculate button clicked for profile:", profiles[selectedProfileIndex].nickname);
                displayProfileResults();
                saveProfiles(); 
            } catch (e) {
                console.error("Error on calculateBtn click:", e);
                alert("Erro ao calcular: " + e.message);
            }
        } else {
            alert("Por favor, selecione um perfil para calcular ou termine a edi√ß√£o.");
        }
    };

    function getEnhancedActionPlan(category, ageYears, activityLevel, sex) {
        const plans = [];
        const addAdvice = (type, text) => plans.push({ type, text });

        addAdvice('general', "Lembre-se que estas s√£o sugest√µes gerais. Aconselhamento individualizado de um profissional de sa√∫de √© fundamental.");

        if(category === "Risco de Obesidade" || category === "Excesso de Peso (Sobrepeso)" || category === "Obesidade Grau I" || category === "Obesidade Grau II" || category === "Obesidade Grau III (M√≥rbida)"){
            addAdvice('medical', "Consultar um profissional de sa√∫de (m√©dico, nutricionista) para avalia√ß√£o detalhada e plano de acompanhamento espec√≠fico.");
            addAdvice('diet', "Foco em escolhas alimentares saud√°veis: aumentar consumo de vegetais, frutas e fibras; reduzir alimentos processados, a√ßucarados e gorduras saturadas.");
            addAdvice('activity', "Incentivar atividade f√≠sica di√°ria. Para " + category.toLowerCase() + ", aumentar gradualmente o tempo e a intensidade.");
            if (activityLevel === "Sedent√°rio") {
                addAdvice('activity', "Come√ßar com pequenas metas de atividade, como 30 minutos de caminhadas ligeiras ou outras atividades que aprecie.");
            }
            addAdvice('lifestyle', "Reduzir tempo sedent√°rio (ex: ecr√£s) e promover atividades ativas no dia-a-dia/em fam√≠lia.");
        } else if (category === "Risco de Baixo Peso (Magreza)" || category === "Risco de Magreza Acentuada" || category === "Baixo Peso") {
            addAdvice('medical', "Consultar um profissional de sa√∫de para investigar poss√≠veis causas e assegurar um aporte cal√≥rico e nutricional adequado.");
            addAdvice('diet', "Considerar refei√ß√µes mais frequentes e densas em nutrientes e calorias saud√°veis.");
            if (ageYears < 20) {
                addAdvice('diet', "N√£o for√ßar a alimenta√ß√£o; criar um ambiente positivo √†s refei√ß√µes.");
            }
        } else { // Peso Normal
            addAdvice('general', "Parab√©ns por manter um peso saud√°vel! Continuar a promover h√°bitos de alimenta√ß√£o equilibrada e atividade f√≠sica regular.");
            addAdvice('medical', "Monitorizar o seu peso e sa√∫de regularmente com o seu profissional de sa√∫de.");
        }

        if (activityLevel === "Sedent√°rio" && category === "Peso Normal") {
            addAdvice('activity', "Apesar do peso normal, √© importante aumentar o n√≠vel de atividade f√≠sica para benef√≠cios de sa√∫de gerais e preven√ß√£o futura.");
        } else if (activityLevel === "Moderado" && (category === "Peso Normal" || category.includes("Excesso de Peso") || category.includes("Obesidade"))) {
            addAdvice('activity', "O seu n√≠vel de atividade √© moderado. Considerar aumentar a frequ√™ncia ou intensidade para otimizar benef√≠cios, especialmente se houver excesso de peso.");
        } else if (activityLevel === "Ativo" || activityLevel === "Muito Ativo") {
            addAdvice('activity', `Continuar com o n√≠vel de atividade ${activityLevel.toLowerCase()} √© √≥timo! Varie as atividades para manter o interesse.`);
        }
        addAdvice('lifestyle', "Garantir sono adequado, fundamental para a sa√∫de e regula√ß√£o hormonal.");
        return plans;
    }
    function renderSimplifiedGrowthChart(profile, ageYears) { if(growthChartInstance){growthChartInstance.destroy();}const historyData=(profile.imcHistory||[]).map(entry=>({x:entry.totalMonths,y:entry.bmi}));historyData.sort((a,b)=>a.x-b.x);let whoCurveDatasets = [];if (ageYears < 20 && ageYears >= 1) { const whoLineDefinitions=[{zValue:-2,label:'Limite: Risco Baixo Peso',color:'rgba(255,193,7,0.8)',dash:[5,5]},{zValue:0,label:'Linha M√©dia (Ideal)',color:'rgba(75,192,75,0.9)',dash:[]},{zValue:1,label:'Limite: Risco Excesso Peso',color:'rgba(255,159,64,0.8)',dash:[5,5]},{zValue:2,label:'Limite: Risco Obesidade',color:'rgba(255,99,132,0.8)',dash:[5,5]}];let minAgeChart=60;let maxAgeChart=228;if(historyData.length>0){const ages=historyData.map(d=>d.x);minAgeChart=Math.max(60,Math.min(...ages)-24);maxAgeChart=Math.min(228,Math.max(...ages)+24);}else{minAgeChart=Math.max(60,profile.totalMonthsAtCreation-24);maxAgeChart=Math.min(228,profile.totalMonthsAtCreation+24);}const chartAgeRangeMonths=Array.from({length:Math.max(1,maxAgeChart-minAgeChart+1)},(_,i)=>minAgeChart+i);for(const lineDef of whoLineDefinitions){const curveData=[];for(const ageM of chartAgeRangeMonths){const lms=getLMSForAge(profile.genero,ageM);if(lms){const[L,M,S]=lms;let bmiAtZ;if(L!==0){bmiAtZ=M*Math.pow((L*S*lineDef.zValue+1),(1/L));}else{bmiAtZ=M*Math.exp(S*lineDef.zValue);} if(!isNaN(bmiAtZ)&&bmiAtZ>5&&bmiAtZ<45){curveData.push({x:ageM,y:bmiAtZ});}}} if(curveData.length>1){whoCurveDatasets.push({label:lineDef.label,data:curveData,borderColor:lineDef.color,borderWidth:2,pointRadius:0,borderDash:lineDef.dash,fill:false,tension:0.2});}}} if(!growthChartCtx){console.error("Growth chart context not found!"); return;} growthChartInstance=new Chart(growthChartCtx,{type:'line',data:{datasets:[{label:`IMC de ${profile.nickname}`,data:historyData,borderColor:'#007bff',backgroundColor:'rgba(0,123,255,0.1)',fill:true,tension:0.2,pointRadius:5,pointBackgroundColor:'#007bff',pointBorderColor:'#fff',pointHoverRadius:7,borderWidth:3},...whoCurveDatasets]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{type:'linear',position:'bottom',title:{display:true,text:'Idade (em anos)',font:{size:14,weight:'500'}},ticks:{stepSize:12,callback:function(value){return(value/12);},font:{size:12}}},y:{title:{display:true,text:'IMC (kg/m¬≤)',font:{size:14,weight:'500'}},min:10,max:38,ticks:{font:{size:12},padding:5}}},plugins:{title:{display:true,text:`Evolu√ß√£o do IMC de ${profile.nickname} ${ageYears < 20 ? '(Ref. OMS Simplificada)' : ''}`,font:{size:16,weight:'500'},padding:{top:15,bottom:25}},legend:{position:'bottom',labels:{boxWidth:15,padding:20,font:{size:12}}},tooltip:{backgroundColor:'rgba(0,0,0,0.8)',titleFont:{size:14},bodyFont:{size:13},padding:12,callbacks:{title:function(tooltipItems){const ageTotalMonths=tooltipItems[0].parsed.x;const years=Math.floor(ageTotalMonths/12);const months=ageTotalMonths%12;return`Idade: ${years}a ${months}m`;},label:function(context){let label=context.dataset.label||'';if(label){label+=': ';}if(context.parsed.y!==null){label+=context.parsed.y.toFixed(2)+' kg/m¬≤';}return label;}}}},interaction:{mode:'index',intersect:false},}}); }
    function renderCurrentStatusChart(profile, currentIMC, totalMonths, ageYears) { if(currentStatusChartInstance){currentStatusChartInstance.destroy();}let barLabels = [], barBMIValues = [], barColors = [];if (ageYears >= 20) { barLabels = ['Baixo Peso (<18.5)','Peso Normal (18.5-24.9)','Sobrepeso (25-29.9)','Obesidade I (30-34.9)','Obesidade II (35-39.9)','Obesidade III (‚â•40)'];barBMIValues = [18.49, 24.9, 29.9, 34.9, 39.9, 45]; barColors = ['rgba(108,117,125,0.7)','rgba(75,192,75,0.7)','rgba(255,193,7,0.7)','rgba(255,159,64,0.7)','rgba(255,99,132,0.7)','rgba(192,57,43,0.7)']; if (currentIMC < 18.5 && !barLabels.includes('Baixo Peso (<18.5)')) { barLabels.unshift('Baixo Peso (<18.5)'); barBMIValues.unshift(18.49); barColors.unshift('rgba(108,117,125,0.7)');}} else { const zScoresForBars=[-2,0,1,2];barLabels=['Limite: Risco Baixo Peso','Linha M√©dia (Ideal)','Limite: Risco Excesso Peso','Limite: Risco Obesidade'];barBMIValues=zScoresForBars.map(z=>calculateBMIFromZScore(z,totalMonths,profile.genero));barColors=['rgba(255,193,7,0.8)','rgba(75,192,75,0.9)','rgba(255,159,64,0.8)','rgba(255,99,132,0.8)'];} const displayLabels=[...barLabels, `O SEU IMC ATUAL (${profile.nickname})`];const displayBMIValues=[...barBMIValues, currentIMC];const displayColors=[...barColors, 'rgba(0,123,255,0.9)'];if(!currentStatusChartCtx){console.error("Current status chart context not found!"); return;} currentStatusChartInstance=new Chart(currentStatusChartCtx,{type:'bar',data:{labels:displayLabels,datasets:[{label:'IMC (kg/m¬≤)',data:displayBMIValues,backgroundColor:displayColors,borderColor:displayColors.map(color=>color.replace(/0\.[7-9]/,'1')),borderWidth:1,barPercentage:0.7,categoryPercentage:0.8}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',scales:{x:{title:{display:true,text:'Valor de IMC (kg/m¬≤)',font:{size:14,weight:'500'}},ticks:{font:{size:12},padding:5}},y:{ticks:{font:{size:12},padding:5}}},plugins:{title:{display:true,text:`Seu IMC Atual vs. Refer√™ncias (Idade: ${profile.ageYears}a ${profile.ageMonthsSub}m)`,font:{size:16,weight:'500'},padding:{top:15,bottom:20}},legend:{display:false}}}});}
    
    if(ui.showGrowthChartBtn) ui.showGrowthChartBtn.onclick = () => { if(ui.growthChartCanvasEl)ui.growthChartCanvasEl.style.display='block';if(ui.currentStatusChartCanvasEl)ui.currentStatusChartCanvasEl.style.display='none';ui.showGrowthChartBtn.classList.add('active-chart-btn');if(ui.showStatusChartBtn)ui.showStatusChartBtn.classList.remove('active-chart-btn');if(selectedProfileIndex>=0&&!isEditingProfile&&profiles[selectedProfileIndex]){if(!growthChartInstance)renderSimplifiedGrowthChart(profiles[selectedProfileIndex], profiles[selectedProfileIndex].ageYears);}};
    if(ui.showStatusChartBtn) ui.showStatusChartBtn.onclick = () => { if(ui.growthChartCanvasEl)ui.growthChartCanvasEl.style.display='none';if(ui.currentStatusChartCanvasEl)ui.currentStatusChartCanvasEl.style.display='block';if(ui.showGrowthChartBtn)ui.showGrowthChartBtn.classList.remove('active-chart-btn');ui.showStatusChartBtn.classList.add('active-chart-btn');if(selectedProfileIndex>=0&&!isEditingProfile&&profiles[selectedProfileIndex]){const profile=profiles[selectedProfileIndex];const imc=parseFloat(calculateIMC(profile.weight,profile.height).toFixed(2));let currentTotalMonths=(profile.ageYears*12)+profile.ageMonthsSub;if(!currentStatusChartInstance)renderCurrentStatusChart(profile,imc,currentTotalMonths, profile.ageYears);}};
    
    if(ui.learnMoreBtn && ui.educationalModal) ui.learnMoreBtn.onclick = () => { ui.educationalModal.style.display = "block"; };
    if(ui.modalCloseBtn && ui.educationalModal) ui.modalCloseBtn.onclick = () => { ui.educationalModal.style.display = "none"; };
    window.onclick = (event) => { if (ui.educationalModal && event.target == ui.educationalModal) { ui.educationalModal.style.display = "none"; } };

    const PDF_STYLES = { PAGE_MARGIN:40,COLOR_TITLE:"#005ea2",COLOR_SECTION_HEADER:"#00528e",COLOR_TEXT_PRIMARY:"#3f4a54",COLOR_TEXT_SECONDARY:"#5a6268",COLOR_TEXT_MUTED:"#6c757d",FONT_SIZE_MAIN_TITLE:20,FONT_SIZE_SECTION_TITLE:14,FONT_SIZE_BODY:12,FONT_SIZE_SMALL:10,FONT_SIZE_XSMALL:9,LINE_SPACING_LARGE:35,LINE_SPACING_MEDIUM:25,LINE_SPACING_NORMAL:20,LINE_SPACING_SMALL:10,LINE_SPACING_ITEM:8,INDENT:10 };
    function checkAndAddPage(pdf, currentY, contentHeight, pageMargin) { if(currentY+contentHeight > pdf.internal.pageSize.getHeight()-pageMargin){pdf.addPage();return pageMargin;}return currentY; }
    function drawPdfHeaderAndProfile(pdf, profile, currentY, S) { pdf.setFontSize(S.FONT_SIZE_MAIN_TITLE);pdf.setTextColor(S.COLOR_TITLE);pdf.text(`Relat√≥rio de IMC e Sa√∫de - ${profile.nickname}`,S.PAGE_MARGIN,currentY);currentY+=S.LINE_SPACING_LARGE;pdf.setFontSize(S.FONT_SIZE_BODY);pdf.setTextColor(S.COLOR_TEXT_PRIMARY);pdf.text(`Data do Relat√≥rio: ${new Date().toLocaleDateString('pt-PT')}`,S.PAGE_MARGIN,currentY);currentY+=S.LINE_SPACING_NORMAL;const ageString=`Idade (no c√°lculo): ${profile.ageYears} anos e ${profile.ageMonthsSub} meses`;pdf.text(ageString,S.PAGE_MARGIN,currentY);pdf.text(`G√©nero: ${profile.genero}`,S.PAGE_MARGIN+pdf.getStringUnitWidth(ageString)*S.FONT_SIZE_BODY+30,currentY);currentY+=S.LINE_SPACING_NORMAL;let activityCommentPdf="";switch(profile.activity){case"Sedent√°rio":activityCommentPdf="Importante aumentar.";break;case"Moderado":activityCommentPdf="Bom! Considerar aumentar.";break;case"Ativo":activityCommentPdf="Excelente! Manter.";break; case "Muito Ativo": activityCommentPdf = "Fant√°stico! Continue."; break;}pdf.text(`N√≠vel de Atividade: ${profile.activity} (${activityCommentPdf})`,S.PAGE_MARGIN,currentY);currentY+=S.LINE_SPACING_MEDIUM;pdf.setLineWidth(0.5);pdf.line(S.PAGE_MARGIN,currentY-5,pdf.internal.pageSize.getWidth()-S.PAGE_MARGIN,currentY-5);currentY+=S.LINE_SPACING_NORMAL;return currentY;}
    function drawPdfWhoResults(pdf, currentY, S, contentWidth) { 
        pdf.setFontSize(S.FONT_SIZE_SECTION_TITLE);pdf.setTextColor(S.COLOR_SECTION_HEADER);pdf.text("Avalia√ß√£o Nutricional:",S.PAGE_MARGIN,currentY); 
        currentY+=S.LINE_SPACING_MEDIUM;
        const numFieldsPerRow=2;const fieldWidth=(contentWidth/numFieldsPerRow)-(S.INDENT*(numFieldsPerRow-1)/numFieldsPerRow);let fieldX=S.PAGE_MARGIN;let initialYForRow=currentY;
        const profile = profiles[selectedProfileIndex]; 
        const resultsData=[
            {label:"Altura",value:(ui.profileHeight?ui.profileHeight.textContent:'N/A')+" cm"},
            {label:"Peso",value:(ui.profileWeight?ui.profileWeight.textContent:'N/A')+" kg"},
            {label:"IMC",value:(ui.imcValue?ui.imcValue.textContent:'N/A')+" kg/m¬≤"},
            {label:"Categoria de IMC",value:ui.whoCategory?ui.whoCategory.textContent:'N/A'}, 
        ];
        if (profile && profile.ageYears < 20) {
            resultsData.push({label:"Z-Score (OMS)",value:ui.whoZScore?ui.whoZScore.textContent:'N/A'});
            resultsData.push({label:"Percentil (OMS)",value:(ui.whoPercentile?ui.whoPercentile.textContent:'N/A')+"¬∫"});
        }

        resultsData.forEach((item,index)=>{
            let currentFieldWidth = fieldWidth;
            if (index === resultsData.length - 1 && (resultsData.length % numFieldsPerRow !== 0 || numFieldsPerRow === 1)) {
                 currentFieldWidth = contentWidth; 
            }
            if(index > 0 && index % numFieldsPerRow === 0){currentY=initialYForRow+35+5;fieldX=S.PAGE_MARGIN;initialYForRow=currentY;}
            drawField(pdf,fieldX,initialYForRow,currentFieldWidth,item.value,item.label,S);
            if (index === resultsData.length - 1 && (resultsData.length % numFieldsPerRow === 0) && numFieldsPerRow > 1) {
            } else if (index < resultsData.length - 1 && (index + 1) % numFieldsPerRow !== 0) {
                 fieldX += currentFieldWidth + S.INDENT; 
            }
        });
        currentY=initialYForRow+35+5+S.LINE_SPACING_MEDIUM;return currentY;
    }
    function drawField(pdf, x, y, width, value, label, S) { const fieldHeight=35;const labelOffsetY=12;const valueOffsetY=25;const textIndent=5;pdf.setFillColor(248,249,250);pdf.setDrawColor(222,226,230);pdf.roundedRect(x,y,width,fieldHeight,3,3,'FD');pdf.setFontSize(S.FONT_SIZE_XSMALL);pdf.setTextColor(S.COLOR_TEXT_SECONDARY);pdf.text(label,x+textIndent,y+labelOffsetY);pdf.setFontSize(S.FONT_SIZE_BODY);pdf.setTextColor(S.COLOR_TEXT_PRIMARY);pdf.text(value,x+textIndent,y+valueOffsetY);}
    function drawPdfOneChart(pdf, currentY, S, contentWidth, chartCanvasId, chartTitleText) {
        const chartCanvas = $(chartCanvasId);
        const chartInstance = chartCanvasId === 'growthChartCanvas' ? growthChartInstance : currentStatusChartInstance;
        if (!chartCanvas || !chartInstance) { console.warn(`Chart instance or canvas for ${chartCanvasId} not for PDF. Skipping.`); return currentY; }
        const chartTitleHeight = S.FONT_SIZE_SECTION_TITLE + S.LINE_SPACING_MEDIUM;
        const minChartPortionHeight = 50; 
        if (currentY + chartTitleHeight + minChartPortionHeight > pdf.internal.pageSize.getHeight() - S.PAGE_MARGIN) { pdf.addPage(); currentY = S.PAGE_MARGIN; }
        pdf.setFontSize(S.FONT_SIZE_SECTION_TITLE); pdf.setTextColor(S.COLOR_SECTION_HEADER); pdf.text(chartTitleText, S.PAGE_MARGIN, currentY); currentY += S.LINE_SPACING_MEDIUM;
        const tempCanvas = document.createElement('canvas'); const imageScaleFactor = 4; 
        const originalCanvasWidth = chartCanvas.width || 300; const originalCanvasHeight = chartCanvas.height || 150;
        tempCanvas.width = originalCanvasWidth * imageScaleFactor; tempCanvas.height = originalCanvasHeight * imageScaleFactor;
        const tempCtx = tempCanvas.getContext('2d'); tempCtx.scale(imageScaleFactor, imageScaleFactor); tempCtx.fillStyle = '#FFFFFF'; tempCtx.fillRect(0, 0, originalCanvasWidth, originalCanvasHeight);
        try { tempCtx.drawImage(chartCanvas, 0, 0, originalCanvasWidth, originalCanvasHeight); }
        catch (e) { console.error("Error drawing chart to temp canvas for PDF:", e); pdf.setTextColor(255, 0, 0); pdf.text("Erro ao gerar imagem do gr√°fico.", S.PAGE_MARGIN + S.INDENT, currentY); currentY += S.LINE_SPACING_NORMAL; return currentY; }
        const imgData = tempCanvas.toDataURL('image/png', 1.0); 
        const pdfChartWidth = contentWidth * 0.8; const pdfChartHeight = (originalCanvasHeight * pdfChartWidth) / originalCanvasWidth;
        if (currentY + pdfChartHeight > pdf.internal.pageSize.getHeight() - S.PAGE_MARGIN) { pdf.addPage(); currentY = S.PAGE_MARGIN; pdf.setFontSize(S.FONT_SIZE_SECTION_TITLE); pdf.setTextColor(S.COLOR_SECTION_HEADER); pdf.text(chartTitleText, S.PAGE_MARGIN, currentY); currentY += S.LINE_SPACING_MEDIUM; }
        pdf.addImage(imgData, 'PNG', S.PAGE_MARGIN + (contentWidth - pdfChartWidth) / 2, currentY, pdfChartWidth, pdfChartHeight);
        currentY += pdfChartHeight + S.LINE_SPACING_MEDIUM; return currentY;
    }
    function drawPdfActionPlan(pdf, currentY, S, contentWidth) { const planTitleHeight=S.FONT_SIZE_SECTION_TITLE+S.LINE_SPACING_MEDIUM;currentY=checkAndAddPage(pdf,currentY,planTitleHeight+50,S.PAGE_MARGIN);pdf.setFontSize(S.FONT_SIZE_SECTION_TITLE);pdf.setTextColor(S.COLOR_SECTION_HEADER);pdf.text("Plano de A√ß√£o Sugerido:",S.PAGE_MARGIN,currentY);currentY+=S.LINE_SPACING_MEDIUM;pdf.setFontSize(S.FONT_SIZE_SMALL);pdf.setTextColor(S.COLOR_TEXT_PRIMARY);const planListUl=ui.planList; if(planListUl){const planListItems=planListUl.getElementsByTagName('li');for(let i=0;i<planListItems.length;i++){const itemTextLines=pdf.splitTextToSize(`${planListItems[i].getAttribute('data-icon') || '‚Ä¢'} ${planListItems[i].textContent}`,contentWidth-S.INDENT);const itemBlockHeight=itemTextLines.length*S.LINE_SPACING_SMALL+S.LINE_SPACING_ITEM;currentY=checkAndAddPage(pdf,currentY,itemBlockHeight,S.PAGE_MARGIN);if(currentY===S.PAGE_MARGIN){pdf.setFontSize(S.FONT_SIZE_SMALL);pdf.setTextColor(S.COLOR_TEXT_PRIMARY);} pdf.text(itemTextLines,S.PAGE_MARGIN+S.INDENT,currentY);currentY+=itemBlockHeight;}} currentY+=S.LINE_SPACING_SMALL;return currentY;}
    function drawPdfDisclaimer(pdf, currentY, S, contentWidth) { const disclaimer="Lembre-se: os c√°lculos da OMS s√£o simplificados para demonstra√ß√£o. Estas s√£o sugest√µes gerais. Consulte sempre um profissional de sa√∫de para aconselhamento personalizado.";const disclaimerLines=pdf.splitTextToSize(disclaimer,contentWidth);const disclaimerHeight=disclaimerLines.length*S.FONT_SIZE_XSMALL+S.LINE_SPACING_SMALL;currentY=checkAndAddPage(pdf,currentY,disclaimerHeight,S.PAGE_MARGIN);pdf.setFontSize(S.FONT_SIZE_XSMALL);pdf.setTextColor(S.COLOR_TEXT_SECONDARY);pdf.text(disclaimerLines,S.PAGE_MARGIN,currentY);currentY+=disclaimerHeight;return currentY;}

    if(ui.exportBtn) ui.exportBtn.onclick = () => {
        if(selectedProfileIndex<0||isEditingProfile||!profiles[selectedProfileIndex]){alert('Selecione um perfil e calcule os resultados para exportar.');return;}
        const profile=profiles[selectedProfileIndex];let chartsReadyForExport=true;
        try{
            if(!growthChartInstance && ui.growthChartCanvasEl ){renderSimplifiedGrowthChart(profile, profile.ageYears);}
            if(!currentStatusChartInstance && ui.currentStatusChartCanvasEl){const imc=parseFloat(calculateIMC(profile.weight,profile.height).toFixed(2));let currentTotalMonths=(profile.ageYears*12)+profile.ageMonthsSub;renderCurrentStatusChart(profile,imc,currentTotalMonths, profile.ageYears);}
            if(!growthChartInstance||!currentStatusChartInstance){chartsReadyForExport=false;}
        }catch(renderError){console.error("Erro ao renderizar gr√°ficos para PDF:",renderError);alert("Ocorreu um erro ao preparar os gr√°ficos. Tente novamente.");chartsReadyForExport=false;return;}
        if(!chartsReadyForExport){alert("Gr√°ficos n√£o prontos. Tente calcular novamente.");return;}
        
        setTimeout(()=>{
            try {
                const{jsPDF}=window.jspdf;const pdf=new jsPDF({unit:'pt',format:'a4'});const S=PDF_STYLES;
                const contentWidth=pdf.internal.pageSize.getWidth()-(2*S.PAGE_MARGIN);let currentY=S.PAGE_MARGIN;
                currentY=drawPdfHeaderAndProfile(pdf,profile,currentY,S);
                currentY=drawPdfWhoResults(pdf,currentY,S,contentWidth);
                currentY=drawPdfOneChart(pdf,currentY,S,contentWidth,'growthChartCanvas', profile.ageYears < 20 ? "Curva de IMC (OMS - Simplificada e Ilustrativa):" : "Evolu√ß√£o do IMC:");
                currentY=drawPdfOneChart(pdf,currentY,S,contentWidth,'currentStatusChartCanvas',`IMC Atual (${profile.nickname}) vs. Refer√™ncias:`);
                currentY=drawPdfActionPlan(pdf,currentY,S,contentWidth);
                currentY=drawPdfDisclaimer(pdf,currentY,S,contentWidth);

                const pageCount = pdf.internal.getNumberOfPages();
                for(let i = 1; i <= pageCount; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(S.FONT_SIZE_XSMALL);
                    pdf.setTextColor(S.COLOR_TEXT_MUTED); // Ensure this color is defined in PDF_STYLES
                    pdf.text(`P√°gina ${i} de ${pageCount}`, pdf.internal.pageSize.getWidth() / 2, pdf.internal.pageSize.getHeight() - (S.PAGE_MARGIN / 2), { align: 'center' });
                }

                pdf.save(`Relatorio_IMC_Saude_${profile.nickname.replace(/\s+/g,'_')}_${new Date().toLocaleDateString('pt-PT').replace(/\//g,'-')}.pdf`);
            } catch (pdfError) {
                console.error("Erro durante a gera√ß√£o do PDF:", pdfError);
                alert("Ocorreu um erro ao gerar o PDF: " + pdfError.message);
            }
        },400); 
    };

    // Initial page setup
    renderProfilesList();
    if(ui.exportBtn) ui.exportBtn.disabled = true;
    if(ui.calculateBtn) ui.calculateBtn.onclick = () => {
        if (selectedProfileIndex >= 0 && !isEditingProfile && profiles[selectedProfileIndex]) {
            try {
                console.log("Calculate button clicked for profile:", profiles[selectedProfileIndex].nickname);
                displayProfileResults();
                saveProfiles(); 
            } catch (e) {
                console.error("Error on calculateBtn click:", e);
                alert("Erro ao calcular: " + e.message);
            }
        } else {
            alert("Por favor, selecione um perfil para calcular ou termine a edi√ß√£o.");
        }
    };
    updateSelectedProfileDisplay(); 
    clearResultsAndCharts(); 

  }); // End of DOMContentLoaded
  </script>
</body>
</html>

